# About design

SmokeRand design philosophy resembles such TestU01 batteries as SmallCrush,
Crush and BigCrush: implemented statistical tests are grouped into predefined
batteries that consume fixed samples from a tested generator. It differs from
PractRand and gjrand where tests are adaptive, i.e. gradually accumulate
statistics from input samples. An important goal during SmokeRand development
was to overcome TestU01 limitations such as support of only 32-bit PRNGs,
some problems with lower bits analysis, absence of multithreading support.

Analysis of the lowest bits of generators output that improves sensitivity
of tests, e.g. linear complexity, matrix rank or birthday spacings test.

A set of tests implemented in SmokeRand is probably not exhaustive but is
intended to catch different types of statistical flaws. The main sources
of inspiration:

- NIST STS: frequency tests (in SmokeRand - for 1, 8 and 16-bit blocks).
- TestU01: birthday spacings, collision over, matrix rank, classicaal gap test,
  linear complexity, sumcollector test.
- PractRand: Hamming weights based tests, `mod3` test.
- gjrand: `rda16` gap test modification.

# Compilation

Some basic compilation tips are given in `README.md`, here we consider only
targeting less-common platforms, usage of compiler-dependent C features (such
as 128-bit arithmetics), working in memory-constrained environment etc.

## Usage of Ninja and WMake

Usage of Ninja and WMake requires Lua 5.x interpreter for generation of
`build.ninja` or `Makefile.wat` scripts respectively. See `cfg_ninja.lua` and
`cfg_wmake.lua` for details.

### Ninja

The `build.ninja` script is generated by `cfg_ninja.lua` Lua script. Usage

    $ lua cfg_ninja.lua cfg_name
    $ ninja

Supported configurations:

- `gcc`, `mingw`: gcc with POSIX threads.
- `gcc32`: gcc, cross-compilation for 32-bit platforms.
- `msvc`: Microsoft Visual C, automatic resolution of `.h`-file dependencies
  is supported only for English version of MSVC.
- `mingw-hx`: 32-bit binaries friendly to HX DOS Extender.
- `zigcc`: clang from Zig programming language distribution as `zig cc`
  command, WinAPI threads will be used.

### WMake (Open Watcom)

Designed for Open Watcom C/C++, compiles for 32-bit Windows NT, 32-bit DOS
(with extenders) and 16-bit DOS. The dynamic libraries with PRNGs (DLLs)
are shared between Windows and 32-bit DOS version. The `Makefile.wat` makefile
for `wmake` is generated by means of the `cfg_wmake.lua` script:

    > lua cfg_wmake.lua
    > wmake -f Makefile.wat


## Requirements for compiler and hardware

Minimal requirements:

- C99 compiler; C99 standard was chosen instead of C89 due to mandatory support
  of 64-bit integers and `inline` keyword.
- GNU make.
- 32-bit CPU.
- 1 GiB of RAM.

Recommended configuration:

- C99 compiler with 128-bit integers support either through `__uint128_t` type
  (GCC, Clang) or `_umul128`/`_addcarry_u64` intrinsics (Microsoft Visual C).
  They will significantly improve performance of some PRNGs such as 128-bit
  LCGs and MWCs, RANLUX++, wyrand etc.
- 64-bit CPU; in the case of x86-64 -- support of RDTSC and RDSEED instructions
  and AVX2 instructions set by a compiler.
- Multithreading support: pthreads (POSIX threads) library of WinAPI threads.
- CMake or Ninja + Lua 5.x for compilation by means of MSVC. Or Lua 5.x for
  compilation by means of Open Watcom C.
- 16 GiB of RAM, especially for multithreaded mode and/or `birthday` battery.

The next compilers are supported: GCC (including MinGW and DJGPP), Clang (as
zig cc), MSVC (Microsoft Visual C) and Open Watcom C. It allows to compile
SmokeRand under Windows, UNIX-like systems and DOS. A slightly modified 16-bit
version (`apps/sr_tiny.c`) of `express` battery can be compiled even by Borland
Turbo C 2.0 or any other ANSI C (C89) compiler.

## Usage in memory constrained environment

32-bit DOS version was tested in VirtualBox virtual machine with 512 MiB
of RAM, customization of "CollisionOver" tests allows to run SmokeRand even
at 64 MiB of RAM. The version of `express` battery for 16-bit computers
(`apps/sr_tiny.c`) can run even at 8086 with 640 KiB of RAM, tested in DosBOX.

The next tests will require a special tuning for running in an environment
with limited amount of RAM, e.g. under 32-bit DOS extenders on old hardware:

- `gap16_count0` may consume several MiB for gaps and frequencies tables.
  Probably RAM consumption may be significantly reduces but it may slow down
  and complicate a program for 64-bit environments.
- `bspace` uses more than 64 MiB of memory for 64-bit values. Its 32-bit
  variant needs less than 256 KiB of RAM.
- `collover` may use about 0.5 GiB of memory in most batteries. It may be
  significantly reduced but the test will be slower and less sensitive
  for 64-bit systems.
- `hamming_ot` uses relatively large (several MiB) frequency tables during
  the run.

## DJGPP

DJGPP supports its own system of dynamically loaded modules in DXE3 format.
They are essentially simplified versions of dynamic libraries / shared objects
common in Windows NT and GNU/Linux. To build with DJGPP use the next command:

    $ make -f Makefile.gnu PLATFORM_NAME=DJGPP

Long file names support must be enabled!

All plugins with PRNGs will be compiled as DXE3 modules using the `dxe3gen`
linker that is specific to DJGPP. It is possible to make SmokeRand DJGPP build
to use DLLs but it will require a cross-compilation of plugins with MinGW or
Open Watcom that is not too practical.

SmokeRand man page can be converted to the overstrike based format using
the next commands:

    $ groff -mandoc -Tascii -P-cBoU smokerand.1 > smokerand.dos
    $ less smokerand.dos

## Loading DLL under DOS

32-bit DOS build for Open Watcom uses a simplified custom DLL loader (see the
`src/pe32loader.c` and `include/pe32loader.h` files) that allows to use properly
compiled plugins with PRNGs even without DOS extender with PE files support.
16-bit DOS version (see `apps/sr_tiny.c`) doesn't support dynamic libraries
at all, tested generators should be embedded into its source code.

As it was mentioned above it is possible to use the same approach for DJGPP
but it is disabled by default. See the `src/threads_intf.c` file for details.


# Batteries

Batteries from TestU01 use the next number of values:

- SmallCrush --- 2^26 values (comparable to `express` battery)
- Crush --- 2^35 values (comparable to `default` battery)
- BigCrush -- 2^38 values (comparable to `full` battery)

However SmokeRand tests are about 5-10 times faster than tests from TestU01
due to optimized implementations that don't use floating point values and
multiplications whenever possible. Birthday spacings tests use radix sort
instead of QuickSort.

